{% extends 'layout.html' %}

{% block title %}Split Dashboard{% endblock %}

{% block content %}
<style>
    /* Machine Status Styles */
    .status-container {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 20px;
        text-align: center;
    }
    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    .machine-status-item {
        background-color: #fff;
        padding: 7px;
        border: 0.5px solid #ccc;
        border-radius: 5px;
        font-size: 1em;
        line-height: 1.5;
    }
    .status {
        display: inline-block;
        margin-top: 4px;
        font-weight: bold;
        padding: 4px 10px;
        border-radius: 4px;
        color: white;
    }
    .status-Start, .status-Running { background-color: #28a745; }
    .status-Idle { background-color: #6c757d; }
    .status-Unknown { background-color: #ffc107; }
    .sequence-info { font-size: 0.9em; color: #333; margin-top: 5px; }
    .time-info { font-size: 0.9em; color: #0056b3; margin-top: 5px; font-weight: bold; }
    
    /* Layout Styles */
    .dashboard-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }
    .panel-left {
        flex: 1;
        min-width: 300px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .panel-right {
        flex: 2;
        min-width: 400px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    /* Table Styles */
    table.data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9rem;
    }
    table.data-table th, table.data-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    table.data-table th {
        background-color: #f8f9fa;
        color: #495057;
        font-weight: 600;
        position: sticky;
        top: 0;
    }
    table.data-table tr:hover {
        background-color: #f2f7ff;
    }
    .btn-select {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-select:hover {
        background-color: #0056b3;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    .table-locked {
        max-height: 500px;
        overflow-y: auto;
    }

    /* Form Styles */
    .form-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: #fff;
        margin-bottom: 15px;
    }
    .input-group { margin-bottom: 10px; }
    .form-input, select.matchine {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .small-row { display: flex; gap: 8px; }
    .small-row .col { flex: 1; }
    .form-button {
        width: 100%;
        padding: 10px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
    }
    .form-button:hover { background-color: #218838; }
    
    /* Selected Row Highlight */
    tr.selected-row {
        background-color: #e3f2fd !important;
    }
</style>

    <!-- Main Content: Cut List & Details -->
    <div class="dashboard-layout">
        <!-- Left Panel: Cut List -->
        <div class="panel-left">
            <h3>Daily Cut List</h3>
            <div class="table-responsive table-locked">
                {% if query_daily_cut %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Seq</th>
                            <th>Date Cut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in query_daily_cut %}
                        <tr>
                            <td>{{ item.cut_sequence }}</td>
                            <td>{{ item.date_cut }}</td>
                            <td>
                                <button class="btn-select" onclick="loadDetails({{ item.cut_sequence }}, this)">Select</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No cut data found.</p>
                {% endif %}
            </div>
        </div>

        <!-- Right Panel: Cut Details -->
        <div class="panel-right">
            <h3>Cut Details <span id="detail-title" style="color: #007bff; font-size: 0.8em;"></span></h3>
            <div id="detail-content" class="table-responsive table-locked">
                <p style="color: #6c757d; padding: 20px; text-align: center;">select a cut from the list to view details.</p>
            </div>
        </div>
    </div>

    <!-- Plan Details Container -->
    <div id="plan-details-container" style="display:none; margin-bottom: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: white; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <h3>Plan Details (Order ID: <span id="plan-order-id"></span>)</h3>
        <div id="plan-content" class="table-responsive">
            <p>Loading...</p>
        </div>
    </div>

<script>
    // Timer Logic
    function updateTimers() {
        const timerElements = document.querySelectorAll('.running-timer');
        timerElements.forEach(timerEl => {
            const startTimeString = timerEl.dataset.starttime;
            if (!startTimeString) return;
            const startTime = new Date(startTimeString);
            startTime.setMinutes(startTime.getMinutes() + 5); // Adjust logic as per original
            const now = new Date();
            let diffInSeconds = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(diffInSeconds / 3600);
            diffInSeconds %= 3600;
            const minutes = Math.floor(diffInSeconds / 60);
            const seconds = diffInSeconds % 60;
            timerEl.textContent = 'Work Time: ' + String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        });
    }
    setInterval(updateTimers, 1000);
    document.addEventListener('DOMContentLoaded', updateTimers);

    // Detail Loading Logic
    // Detail Loading Logic
    function loadDetails(seq, btn) {
        // Highlight logic for Cut List
        if (btn) {
            // Remove existing highlights in this table
            const row = btn.closest('tr');
            const table = row.closest('table');
            table.querySelectorAll('tr.selected-row').forEach(tr => tr.classList.remove('selected-row'));
            row.classList.add('selected-row');
        }

        const detailContainer = document.getElementById('detail-content');
        const detailTitle = document.getElementById('detail-title');
        
        detailTitle.textContent = '(Loading Sequence ' + seq + '...)';
        detailContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Loading details...</p>';

        // Set the sequence input in the Start Split form automatically for convenience
        const seqInput = document.getElementById('sequence');
        if(seqInput) seqInput.value = seq;

        fetch(`/get_daily_cut_detail/${seq}`)
            .then(response => response.json())
            .then(data => {
                detailTitle.textContent = '(Cut_Seq ' + seq + ')';
                
                if (data.error) {
                    detailContainer.innerHTML = `<p style="color:red; text-align:center;">Error: ${data.error}</p>`;
                    return;
                }
                if (data.length === 0) {
                    detailContainer.innerHTML = '<p style="text-align:center; padding: 20px;">No details found for this sequence.</p>';
                    return;
                }

                // Build Table with Action Column
                let tableHtml = '<table class="data-table"><thead><tr>';
                
                const keys = Object.keys(data[0]);
                keys.forEach(key => {
                    tableHtml += `<th>${key}</th>`;
                });
                tableHtml += '<th>Action</th>'; 
                tableHtml += '</tr></thead><tbody>';

                data.forEach(row => {
                    tableHtml += '<tr>';
                    keys.forEach(key => {
                        const val = row[key] !== null ? row[key] : '-';
                        tableHtml += `<td>${val}</td>`;
                    });
                    
                    // Determine sequence value for button
                    let orderSeq = row.sequence || row.Sequence || row.order_id || '';
                    if (orderSeq) {
                        tableHtml += `<td><button class="btn-select" onclick="viewPlan('${orderSeq}', this)">View Plan</button></td>`;
                    } else {
                        tableHtml += `<td>-</td>`;
                    }
                    
                    tableHtml += '</tr>';
                });
                tableHtml += '</tbody></table>';
                
                detailContainer.innerHTML = tableHtml;
            })
            .catch(err => {
                console.error('Error:', err);
                detailTitle.textContent = '(Error)';
                detailContainer.innerHTML = `<p style="color:red; text-align:center;">Failed to load data. See console for details.</p>`;
            });
    }

    // View Plan Logic
    function viewPlan(orderId, btn) {
        // Highlight logic for Cut Details
        if (btn) {
             const row = btn.closest('tr');
             const table = row.closest('table');
             table.querySelectorAll('tr.selected-row').forEach(tr => tr.classList.remove('selected-row'));
             row.classList.add('selected-row');
        }

        const planContainer = document.getElementById('plan-details-container');
        const planContent = document.getElementById('plan-content');
        const planOrderId = document.getElementById('plan-order-id');
        
        planContainer.style.display = "block";
        planContainer.scrollIntoView({behavior: "smooth"});
        
        planOrderId.textContent = orderId;
        planContent.innerHTML = '<p style="text-align: center; padding: 20px;">Loading plan details...</p>';
        
        fetch(`/get_plan_details/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    planContent.innerHTML = `<p style="color:red; text-align:center;">Error: ${data.error}</p>`;
                    return;
                }
                if (data.length === 0) {
                    planContent.innerHTML = '<p style="text-align:center; padding: 20px;">No plan details found.</p>';
                    return;
                }
                
                // Define specific column order and headers
                const columns = [
                    { key: 'material_type', label: 'Material Type' },
                    { key: 'material_size', label: 'Material Size' },
                    { key: 'thickness', label: 'Thickness' },
                    { key: 'width', label: 'Width' },
                    { key: 'length', label: 'Length' },
                    { key: 'quantity', label: 'Quantity' },
                    { key: 'production_status', label: 'Status' }
                ];

                let tableHtml = '<table class="data-table" style="width:100%"><thead><tr>';
                columns.forEach(col => {
                    tableHtml += `<th>${col.label}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';
                
                data.forEach(row => {
                    tableHtml += '<tr>';
                    columns.forEach(col => {
                        let val = row[col.key] !== null && row[col.key] !== undefined ? row[col.key] : '-';
                        
                        // Conditional formatting for Status
                        if (col.key === 'production_status' && val === 'Not Started') {
                             val = `<span style="color: red; font-weight: bold;">${val}</span>`;
                        }
                        
                        tableHtml += `<td>${val}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                tableHtml += '</tbody></table>';
                planContent.innerHTML = tableHtml;
            })
            .catch(err => {
                console.error('Error:', err);
                planContent.innerHTML = `<p style="color:red; text-align:center;">Failed to load plan details.</p>`;
            });
    }
</script>
{% endblock %}
